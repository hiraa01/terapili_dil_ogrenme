<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Psikolog Chatbot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap" rel="stylesheet">
  <style>
    /* ‚Äî Genel Ayarlar ‚Äî */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7fb;
      height: 100vh;
      overflow: hidden;
    }

    /* ‚Äî √úst Men√º ‚Äî */
    .top-navbar {
      background: #007bff;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .top-navbar a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .top-navbar a:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .top-navbar a.active {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ‚Äî Ana Konteyner ‚Äî */
    .main-container {
      display: flex;
      height: calc(100vh - 60px);
    }

    /* ‚Äî Yan Men√º ‚Äî */
    .sidebar {
      width: 280px;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      background: #f8f9fa;
    }

    .new-chat-btn {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .new-chat-btn:hover {
      background: #0056b3;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .chat-item {
      padding: 12px;
      margin: 5px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-item:hover {
      background: #f0f0f0;
    }

    .chat-item.active {
      background: #e3f2fd;
      border-left: 3px solid #007bff;
    }

    .chat-title {
      font-size: 14px;
      color: #333;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .delete-chat {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .chat-item:hover .delete-chat {
      opacity: 1;
    }

    /* ‚Äî Chat Alanƒ± ‚Äî */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .chat-header {
      padding: 16px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-title-header {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    /* ‚Äî Mod Se√ßici ‚Äî */
    .mode-selector {
      padding: 12px 20px;
      border-bottom: 1px solid #e0e0e0;
      background: #fff;
    }

    .mode-selector select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    /* ‚Äî Sohbet Alanƒ± ‚Äî */
    #chatbox {
      flex: 1;
      padding: 20px;
      background: #eef4fb;
      overflow-y: auto;
    }

    .typing {
      padding: 8px 16px;
      color: #666;
      font-style: italic;
      font-size: 14px;
    }

    /* ‚Äî Mesaj Baloncuklarƒ± ‚Äî */
    .message {
      max-width: 75%;
      margin: 8px 0;
      padding: 12px 16px;
      border-radius: 20px;
      position: relative;
      line-height: 1.4;
      clear: both;
      word-break: break-word;
    }

    .message.bot {
      background: #fff;
      color: #333;
      float: left;
      border-bottom-left-radius: 4px;
    }

    .message.bot::after {
      content: '';
      position: absolute;
      top: 12px;
      left: -8px;
      border-top: 8px solid transparent;
      border-right: 8px solid #fff;
      border-bottom: 8px solid transparent;
    }

    .message.user {
      background: #007bff;
      color: #fff;
      float: right;
      border-bottom-right-radius: 4px;
    }

    .message.user::after {
      content: '';
      position: absolute;
      top: 12px;
      right: -8px;
      border-top: 8px solid transparent;
      border-left: 8px solid #007bff;
      border-bottom: 8px solid transparent;
    }

    /* ‚Äî Girdi Alanƒ± ‚Äî */
    .input-area {
      padding: 16px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      background: #fff;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }

    .input-area button {
      margin-left: 12px;
      padding: 12px 20px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .input-area button:hover {
      background: #0056b3;
    }

    /* ‚Äî Bo≈ü durum ‚Äî */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #666;
      text-align: center;
    }

    .empty-state h3 {
      margin-bottom: 10px;
      color: #333;
    }
  </style>
</head>

<body>

  <!-- √úst Men√º -->
  <div class="top-navbar">
    <div>üß† Psikolog Chatbot</div>
    <div>
      <a href="/dashboard">üè† Ana Sayfa</a>
      <a href="/chat" class="active">üí¨ Chatbot</a>
      <a href="/gunluk">üìî G√ºnl√ºk</a>
      <a href="/game">üéÆ Kelime Oyunu</a>
      <a href="/logout">üö™ √áƒ±kƒ±≈ü</a>
    </div>
  </div>

  <!-- Ana Konteyner -->
  <div class="main-container">

    <!-- Yan Men√º -->
    <div class="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" onclick="createNewChat()">üÜï Yeni Sohbet</button>
      </div>
      <div class="chat-list" id="chatList">
        <!-- Sohbet listesi buraya gelecek -->
      </div>
    </div>

    <!-- Chat Alanƒ± -->
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title-header" id="currentChatTitle">Yeni Sohbet</div>
        <a href="/dashboard" class="back-btn">‚Üê Anasayfaya D√∂n</a>
      </div>

      <div class="mode-selector">
        <label for="mode">Mod:</label>
        <select id="mode" onchange="onModeChange()">
          <option value="aile">Aile</option>
          <option value="ask">A≈ük Hayatƒ±</option>
          <option value="akademik">Akademik Hayat</option>
          <option value="serbest">Serbest Konu≈üma</option>
        </select>
      </div>

      <div id="chatbox"></div>
      <div id="typing-indicator" class="typing" style="display:none;">Bot yazƒ±yor...</div>

      <div class="input-area">
        <input type="text" id="userInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." onkeydown="handleKeyPress(event)" />
        <button onclick="sendMessage()">G√∂nder</button>
      </div>
    </div>
  </div>

  <script>
    // Sohbet y√∂netimi
    let chats = [];
    let currentChatId = null;

    // Sayfa y√ºklendiƒüinde
    document.addEventListener('DOMContentLoaded', function () {
      loadChats();
    });

    // Sohbetleri veritabanƒ±ndan y√ºkle
    async function loadChats() {
      try {
        const response = await fetch('/api/chats');
        if (response.ok) {
          chats = await response.json();
          displayChats();

          // ƒ∞lk sohbeti y√ºkle veya yeni sohbet olu≈ütur
          if (chats.length > 0) {
            loadChat(chats[0].id);
          } else {
            createNewChat();
          }
        } else {
          console.error('Sohbetler y√ºklenemedi');
        }
      } catch (error) {
        console.error('Hata:', error);
      }
    }

    // Yeni sohbet olu≈ütur
    async function createNewChat() {
      try {
        const response = await fetch('/api/chats', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: 'Yeni Sohbet'
          })
        });

        if (response.ok) {
          const newChat = await response.json();
          chats.unshift(newChat);
          displayChats();
          loadChat(newChat.id);
        } else {
          console.error('Yeni sohbet olu≈üturulamadƒ±');
        }
      } catch (error) {
        console.error('Hata:', error);
      }
    }

    // Sohbeti y√ºkle
    async function loadChat(chatId) {
      currentChatId = chatId;
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;

      // Ba≈ülƒ±ƒüƒ± g√ºncelle
      document.getElementById('currentChatTitle').textContent = chat.title;

      // Mesajlarƒ± veritabanƒ±ndan y√ºkle
      try {
        const response = await fetch(`/api/chats/${chatId}/messages`);
        if (response.ok) {
          const messages = await response.json();
          displayMessages(messages);
        } else {
          console.error('Mesajlar y√ºklenemedi');
        }
      } catch (error) {
        console.error('Hata:', error);
      }

      // Aktif sohbeti i≈üaretle
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');
    }

    // Mesajlarƒ± g√∂ster
    function displayMessages(messages) {
      const chatbox = document.getElementById('chatbox');
      chatbox.innerHTML = '';

      messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${msg.message_type}`;
        msgDiv.innerHTML = `<strong>${msg.message_type === 'user' ? 'Sen:' : 'Bot:'}</strong> ${msg.message_text}`;
        chatbox.appendChild(msgDiv);
      });

      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Sohbeti sil
    async function deleteChat(chatId, event) {
      event.stopPropagation();

      // √ñzel onay dialogu g√∂ster
      const confirmed = await showDeleteConfirmation();
      if (!confirmed) return;

      try {
        const response = await fetch(`/api/chats/${chatId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          chats = chats.filter(c => c.id !== chatId);
          displayChats();

          if (currentChatId === chatId) {
            if (chats.length > 0) {
              loadChat(chats[0].id);
            } else {
              createNewChat();
            }
          }
        } else {
          console.error('Sohbet silinemedi');
        }
      } catch (error) {
        console.error('Hata:', error);
      }
    }

    // √ñzel silme onay dialogu
    function showDeleteConfirmation() {
      return new Promise((resolve) => {
        // Mevcut dialog varsa kaldƒ±r
        const existingDialog = document.getElementById('deleteDialog');
        if (existingDialog) {
          existingDialog.remove();
        }

        // Yeni dialog olu≈ütur
        const dialog = document.createElement('div');
        dialog.id = 'deleteDialog';
        dialog.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;

        dialog.innerHTML = `
          <div style="
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          ">
            <h3 style="margin-bottom: 20px; color: #333;">Sohbeti Sil</h3>
            <p style="margin-bottom: 25px; color: #666;">Bu sohbeti kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button id="cancelDelete" style="
                padding: 10px 20px;
                border: 1px solid #ccc;
                background: #f8f9fa;
                border-radius: 5px;
                cursor: pointer;
              ">ƒ∞ptal</button>
              <button id="confirmDelete" style="
                padding: 10px 20px;
                border: none;
                background: #dc3545;
                color: white;
                border-radius: 5px;
                cursor: pointer;
              ">Sil</button>
            </div>
          </div>
        `;

        document.body.appendChild(dialog);

        // Event listeners
        document.getElementById('cancelDelete').onclick = () => {
          dialog.remove();
          resolve(false);
        };

        document.getElementById('confirmDelete').onclick = () => {
          dialog.remove();
          resolve(true);
        };

        // Dƒ±≈üarƒ± tƒ±klayƒ±nca iptal
        dialog.onclick = (e) => {
          if (e.target === dialog) {
            dialog.remove();
            resolve(false);
          }
        };
      });
    }

    // Sohbet listesini g√∂ster
    function displayChats() {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';

      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.setAttribute('data-chat-id', chat.id);
        chatItem.onclick = () => loadChat(chat.id);

        chatItem.innerHTML = `
          <div class="chat-title">${chat.title}</div>
          <button class="delete-chat" onclick="deleteChat(${chat.id}, event)">üóëÔ∏è</button>
        `;

        chatList.appendChild(chatItem);
      });
    }

    // Sohbet ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
    async function updateChatTitle(chatId, title) {
      try {
        const response = await fetch(`/api/chats/${chatId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title })
        });

        if (response.ok) {
          const chat = chats.find(c => c.id === chatId);
          if (chat) {
            chat.title = title;
            displayChats();
            document.getElementById('currentChatTitle').textContent = title;
          }
        }
      } catch (error) {
        console.error('Ba≈ülƒ±k g√ºncellenemedi:', error);
      }
    }

    // Enter tu≈üu ile mesaj g√∂nderme
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
      }
    }

    // Mod deƒüi≈üikliƒüi
    async function onModeChange() {
      if (!currentChatId) return;

      const mode = document.getElementById('mode').value;

      try {
        const response = await fetch(`/api/chat/${currentChatId}/mode-change`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ mode })
        });

        if (response.ok) {
          const data = await response.json();

          // Mod deƒüi≈üikliƒüi mesajƒ±nƒ± g√∂ster
          const chatbox = document.getElementById('chatbox');
          const modeDiv = document.createElement('div');
          modeDiv.className = 'message bot mode-change';
          modeDiv.innerHTML = `<strong>Bot:</strong> ${data.message}`;
          chatbox.appendChild(modeDiv);
          chatbox.scrollTop = chatbox.scrollHeight;
        }
      } catch (error) {
        console.error('Mod deƒüi≈üikliƒüi hatasƒ±:', error);
      }
    }

    // Mesaj g√∂nder
    async function sendMessage() {
      const inputEl = document.getElementById('userInput');
      const msg = inputEl.value.trim();
      const mode = document.getElementById('mode').value;
      if (!msg) return;

      if (!currentChatId) {
        await createNewChat();
        return;
      }

      const chatbox = document.getElementById('chatbox');

      // Kullanƒ±cƒ± mesajƒ±nƒ± g√∂ster
      const userDiv = document.createElement('div');
      userDiv.className = 'message user';
      userDiv.innerHTML = `<strong>Sen:</strong> ${msg}`;
      chatbox.appendChild(userDiv);
      chatbox.scrollTop = chatbox.scrollHeight;

      inputEl.value = '';

      // ƒ∞lk mesajsa ba≈ülƒ±ƒüƒ± g√ºncelle
      const chat = chats.find(c => c.id === currentChatId);
      if (chat && chat.title === 'Yeni Sohbet') {
        const shortMsg = msg.length > 30 ? msg.substring(0, 30) + '...' : msg;
        await updateChatTitle(currentChatId, shortMsg);
      }

      // Yazƒ±yor g√∂stergesi
      const typing = document.getElementById('typing-indicator');
      typing.style.display = 'block';

      // Bot yanƒ±tƒ±nƒ± al
      let replyText = '';
      let wordsCount = 0;
      try {
        const res = await fetch('/get', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            msg,
            mode,
            chat_id: currentChatId
          })
        });
        const data = await res.json();
        replyText = data.reply;
        wordsCount = data.words_count || 0;
      } catch (err) {
        console.error(err);
        replyText = "√ñz√ºr dilerim, ≈üu anda yanƒ±t veremiyorum.";
      }

      typing.style.display = 'none';

      // Bot mesajƒ±nƒ± g√∂ster
      const botDiv = document.createElement('div');
      botDiv.className = 'message bot';
      botDiv.innerHTML = '<strong>Bot:</strong> ';
      chatbox.appendChild(botDiv);
      chatbox.scrollTop = chatbox.scrollHeight;

      // Harf harf yazdƒ±r
      let idx = 0;
      function typeWriter() {
        if (idx < replyText.length) {
          botDiv.innerHTML += replyText.charAt(idx);
          idx++;
          chatbox.scrollTop = chatbox.scrollHeight;
          setTimeout(typeWriter, 25);
        } else {
          // Kelime sayƒ±sƒ± bilgisini g√∂ster
          if (wordsCount > 0) {
            const wordsInfo = document.createElement('div');
            wordsInfo.className = 'message bot words-info';
            wordsInfo.style.fontSize = '12px';
            wordsInfo.style.color = '#666';
            wordsInfo.style.fontStyle = 'italic';
            wordsInfo.innerHTML = `üìä ${wordsCount} kelime tespit edildi ve ilerlemenize eklendi!`;
            chatbox.appendChild(wordsInfo);
            chatbox.scrollTop = chatbox.scrollHeight;
          }
        }
      }
      typeWriter();
    }
  </script>

</body>

</html>